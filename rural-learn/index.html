<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Setu: Your AI learning mentor</title>
    <meta name="description" content="Setu: Your AI learning mentor">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script defer src="https://unpkg.com/alpinejs@3.14.1/dist/cdn.min.js" ></script>
    <script src="https://www.gstatic.com/firebasejs/8.2.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.2.8/firebase-auth.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAqX-yvK50wPOFjjM0lF-pOfdMBfThF6-Q",
            authDomain: "react-basics1.firebaseapp.com",
            projectId: "react-basics1",
            storageBucket: "react-basics1.firebasestorage.app",
            messagingSenderId: "15597040839",
            appId: "1:15597040839:web:a9c162efe4e98d020bfae2",
            measurementId: "G-J047Y87R83"
        };
        
        firebase.initializeApp(firebaseConfig);
        
        // Check authentication before loading the app
        firebase.auth().onAuthStateChanged(async (user) => {
            if (!user) {
                window.location.href = 'login/';
                return;
            }
            
            // Check if user is a teacher and redirect to teacher dashboard
            const userRole = localStorage.getItem(`userRole_${user.uid}`);
            if (userRole === 'teacher') {
                window.location.href = 'teacher/';
                return;
            }
            
            // For all non-teacher users, verify they exist as students in the database
            try {
                const response = await fetch('https://tawf54kc575lndv6wj2woqq5uy0fbfez.lambda-url.ap-south-1.on.aws/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: 'verifyStudent',
                        studentEmail: user.email
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (!result.exists) {
                        // Student not found in database, logout
                        alert('Access denied. You are not registered as a student.');
                        firebase.auth().signOut();
                        return;
                    }
                } else {
                    console.error('Failed to verify student');
                    alert('Unable to verify student access. Please try again.');
                    firebase.auth().signOut();
                    return;
                }
            } catch (error) {
                console.error('Error verifying student:', error);
                alert('Unable to verify student access. Please try again.');
                firebase.auth().signOut();
                return;
            }
        });
        
        const timestamp = Date.now();
        document.write(`<script src="app.js?t=${timestamp}"><\/script>`);
        document.write(`<link rel="stylesheet" href="styles.css?t=${timestamp}">`);
    </script>
</head>
<body x-data="sidebarManager()">


    <div class="header">
        <div class="header-left">
            <div class="logo">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="#1a1a1a" viewBox="0 0 256 256"><path d="M200,168a32.06,32.06,0,0,0-31,24H72a32,32,0,0,1,0-64h96a40,40,0,0,0,0-80H72a8,8,0,0,0,0,16h96a24,24,0,0,1,0,48H72a48,48,0,0,0,0,96h97a32,32,0,1,0,31-40Zm0,48a16,16,0,1,1,16-16A16,16,0,0,1,200,216Z"></path></svg>
            </div>
            <span class="header-title">Setu</span>
        </div>
        <div class="header-right">
            <div class="profile-dropdown" x-data="{ open: false }" @click.away="open = false">
                <button class="icon-btn" @click="open = !open">
                    <i class="ph ph-user ph"></i>
                </button>
                <div class="dropdown-menu" x-show="open" x-transition>
                    <button class="dropdown-item" @click="logout()">
                        <i class="ph ph-sign-out"></i>
                        <span>Logout</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="main">
        <div class="sidebar" :class="leftSidebarClasses">
            <div class="sidebar-header">
                <span class="sidebar-title">Units</span>
                <button class="icon-btn" @click="toggleSidebar('left')">
                    <i class="ph ph-list ph"></i>
                </button>
            </div>
            


            <div class="search-box">
                <i class="ph ph-magnifying-glass ph"></i>
                <input type="text" placeholder="Search the unit or chapter" x-model="searchQuery">
            </div>




            <div x-show="showShimmer">
                <template x-for="i in 16" :key="i">
                    <div class="source-item shimmer-item">
                        <div class="source-info">
                            <div class="shimmer-icon"></div>
                            <div class="shimmer-text"></div>
                        </div>
                    </div>
                </template>
            </div>
            
            <div x-show="!showShimmer">
                <template x-for="unit in filteredUnits" :key="unit.name">
                    <div class="source-item" :class="{ 'active': unit.active }" @click="selectChapter(unit)">
                        <div class="source-info">
                            <span class="file-emoji" x-text="unit.emoji"></span>
                            <span class="source-name" x-text="unit.name"></span>
                        </div>
                        <i class="ph ph-check checkmark" x-show="unit.active"></i>
                    </div>
                </template>
            </div>
        </div>

        <div class="content">
            <div class="content-header">
                <div class="content-header-left">
                    <button class="icon-btn" @click="toggleSidebar('left')">
                        <i class="ph ph-sidebar ph"></i>
                    </button>
                    <span class="content-title">Chat</span>
                    <button class="icon-btn">
                        <i class="ph ph-info ph"></i>
                    </button>
                </div>
                <div>
                    <button class="icon-btn" @click="toggleSidebar('right')">
                        <i class="ph ph-sidebar-simple ph"></i>
                    </button>
                </div>
            </div>

            <div class="content-body">
                <!-- Empty State -->
                <div x-show="!selectedChapter && !contentLoading" class="chat-welcome">
                    <div class="welcome-icon">
                        <i class="ph ph-book-open" style="font-size: 48px; color: #4a90e2;"></i>
                    </div>
                    <h1 class="main-title"> Learning Assistant</h1>
                    <div class="welcome-text">
                        Select any chapter from the sidebar to start your personalized learning experience. I'll help you understand concepts, solve problems, and master the fundamentals.
                    </div>
                </div>

                <!-- Loading State -->
                <div x-show="contentLoading" class="chat-welcome">
                    <div class="welcome-icon">
                        <div class="shimmer-icon-large"></div>
                    </div>
                    <div class="shimmer-title-large"></div>
                    <div class="shimmer-description-block">
                        <div class="shimmer-line"></div>
                        <div class="shimmer-line short"></div>
                    </div>
                    <div class="shimmer-suggestions">
                        <template x-for="i in 4" :key="i">
                            <div class="shimmer-card"></div>
                        </template>
                    </div>
                </div>

                <!-- Chapter Content -->
                <div x-show="chapterContent && !contentLoading && messages.length === 0" class="chat-welcome">
                    <div class="welcome-icon">
                        <span style="font-size: 48px;" x-text="chapterContent?.emoji"></span>
                    </div>
                    
                    <h1 class="main-title" x-text="chapterContent?.title"></h1>
                    
                    <div class="welcome-text" x-html="chapterContent?.description"></div>

                    <div class="suggestion-grid">
                        <template x-for="suggestion in chapterContent?.suggestions" :key="suggestion">
                            <div class="suggestion-card" @click="sendSuggestion(suggestion)">
                                <i class="ph ph-chat-circle"></i>
                                <span x-text="suggestion"></span>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- Chat Messages -->
                <div x-show="messages.length > 0" class="chat-messages" id="chatMessages">
                    <template x-for="message in messages" :key="message.id">
                        <div class="message" :class="message.role">
                            <div class="message-content">
                                <div x-show="message.files && message.files.length > 0" class="message-files">
                                    <template x-for="file in message.files" :key="file.name">
                                        <div class="message-file">
                                            <i class="ph" :class="file.type === 'pdf' ? 'ph-file-pdf' : 'ph-image'"></i>
                                            <span x-text="file.name"></span>
                                        </div>
                                    </template>
                                </div>
                                <div class="message-text" x-html="formatMessage(message.content)"></div>
                            </div>
                            <div class="message-time" x-text="formatTime(message.timestamp)"></div>
                        </div>
                    </template>
                    
                    <div x-show="isTyping" class="message assistant">
                        <div class="message-content">
                            <div class="typing-indicator">
                                <span></span><span></span><span></span>
                            </div>
                        </div>
                    </div>
                </div>


            </div>

            <!-- Selected Files Display -->
            <div class="selected-files" x-show="selectedFiles.length > 0">
                <div class="files-scroll">
                    <template x-for="(file, index) in selectedFiles" :key="file.id">
                        <div class="file-chip">
                            <div class="file-icon">
                                <i class="ph" :class="file.type === 'pdf' ? 'ph-file-pdf' : 'ph-image'"></i>
                            </div>
                            <span class="file-name" x-text="file.name"></span>
                            <button class="file-remove" @click="removeFile(index)">
                                <i class="ph ph-x"></i>
                            </button>
                        </div>
                    </template>
                </div>
            </div>

            <div class="input-container">
                <form @submit.prevent="sendMessage()" class="chat-form">
                    <input type="text" class="input-box" x-model="currentMessage" 
                           :placeholder="selectedChapter ? `Ask about ${selectedChapter.name.toLowerCase()} concepts...` : 'Select a chapter to start asking questions...'" 
                           :disabled="!selectedChapter || isTyping">
                    <div class="input-meta">
                        <input type="file" id="fileInput" accept=".pdf,.jpg,.jpeg,.png,.gif,.webp" multiple style="display: none;" @change="handleFileSelect($event)">
                        <button type="button" class="attach-btn" @click="document.getElementById('fileInput').click()" :disabled="selectedFiles.length >= 3 || isTyping">
                            <i class="ph ph-paperclip ph"></i>
                        </button>
                    </div>
                    <button type="submit" class="send-btn" :disabled="!currentMessage.trim() || !selectedChapter || isTyping">
                        <i class="ph ph-paper-plane-right ph"></i>
                    </button>
                </form>
            </div>


        </div>

        <div class="right-sidebar" :class="rightSidebarClasses">
            <div class="studio-header">
                <span class="studio-title">Actions</span>
                <button class="icon-btn" @click="toggleSidebar('right')">
                    <i class="ph ph-list ph"></i>
                </button>
            </div>

            <div class="language-box">
                <div class="language-title">Available in:</div>
                <div class="language-tags">
                    <span class="lang-tag">हिंदी</span>
                    <span class="lang-tag">, English</span>
                    <span class="lang-tag">, ગુજરાતી</span>
                </div>
            </div>

            <div class="menu-item audio-overview" @click="generateAudioOverview()">
                <i class="ph ph-waveform menu-icon"></i>
                <span class="menu-text">Audio Overview</span>
            </div>

            <div class="menu-item career-path" @click="generateCareerPath()">
                <i class="ph ph-path menu-icon"></i>
                <span class="menu-text">Career Path</span>
            </div>

            <div class="menu-item flashcards" @click="generateFlashcards()">
                <i class="ph ph-cards menu-icon"></i>
                <span class="menu-text">Flashcards</span>
            </div>

            <div class="menu-item quiz" @click="generateQuiz()">
                <i class="ph ph-question menu-icon"></i>
                <span class="menu-text">Quiz</span>
            </div>

            <!-- Generated Resources -->
            <div x-show="showGeneratedResources || showGeneratedFlashcards || showGeneratedCareerPath" class="generated-resources">
                <h3 class="resources-title">Generated Resources</h3>
                
                <!-- Quiz Loading State -->
                <div x-show="resourcesLoading" class="resource-item shimmer-resource">
                    <div class="resource-content">
                        <div class="shimmer-resource-icon"></div>
                        <div class="resource-info">
                            <div class="shimmer-resource-title"></div>
                            <div class="shimmer-resource-details"></div>
                        </div>
                    </div>
                    <div class="shimmer-resource-more"></div>
                </div>
                
                <!-- Quiz Resource -->
                <div x-show="showGeneratedResources && !resourcesLoading" class="resource-item" @click="openQuiz()">
                    <div class="resource-content">
                        <div class="resource-icon">
                            <i class="ph ph-question"></i>
                        </div>
                        <div class="resource-info">
                            <div class="resource-title" x-text="selectedChapter ? `${selectedChapter.name} Quiz` : 'Chemistry Quiz'"></div>
                            <div class="resource-details">1 source · Just now</div>
                        </div>
                    </div>
                    <button class="resource-more" @click.stop>
                        <i class="ph ph-dots-three-vertical"></i>
                    </button>
                </div>
                
                <!-- Flashcards Loading State -->
                <div x-show="flashcardsLoading" class="resource-item shimmer-resource">
                    <div class="resource-content">
                        <div class="shimmer-resource-icon"></div>
                        <div class="resource-info">
                            <div class="shimmer-resource-title"></div>
                            <div class="shimmer-resource-details"></div>
                        </div>
                    </div>
                    <div class="shimmer-resource-more"></div>
                </div>
                
                <!-- Flashcards Resource -->
                <div x-show="showGeneratedFlashcards && !flashcardsLoading" class="resource-item" @click="openFlashcards()">
                    <div class="resource-content">
                        <div class="resource-icon">
                            <i class="ph ph-cards"></i>
                        </div>
                        <div class="resource-info">
                            <div class="resource-title" x-text="selectedChapter ? `${selectedChapter.name} Flashcards` : 'Chemistry Flashcards'"></div>
                            <div class="resource-details">10 cards · Just now</div>
                        </div>
                    </div>
                    <button class="resource-more" @click.stop>
                        <i class="ph ph-dots-three-vertical"></i>
                    </button>
                </div>
                
                <!-- Career Path Loading State -->
                <div x-show="careerPathLoading" class="resource-item shimmer-resource">
                    <div class="resource-content">
                        <div class="shimmer-resource-icon"></div>
                        <div class="resource-info">
                            <div class="shimmer-resource-title"></div>
                            <div class="shimmer-resource-details"></div>
                        </div>
                    </div>
                    <div class="shimmer-resource-more"></div>
                </div>
                
                <!-- Career Path Resource -->
                <div x-show="showGeneratedCareerPath && !careerPathLoading" class="resource-item" @click="openCareerPath()">
                    <div class="resource-content">
                        <div class="resource-icon">
                            <i class="ph ph-path"></i>
                        </div>
                        <div class="resource-info">
                            <div class="resource-title" x-text="selectedChapter ? `${selectedChapter.name} Career Path` : 'Chemistry Career Path'"></div>
                            <div class="resource-details">Mind map · Just now</div>
                        </div>
                    </div>
                    <button class="resource-more" @click.stop>
                        <i class="ph ph-dots-three-vertical"></i>
                    </button>
                </div>
            </div>

        </div>
    </div>

    <div class="overlay" :class="{ active: showOverlay }" @click="closeSidebars()"></div>

  <!-- Flashcard Artifact Viewer -->
<div class="artifact-overlay" x-show="showFlashcardModal">
    <div class="artifact-viewer">
        <div class="artifact-header-container">
            <div class="artifact-header">
                <span class="artifact-title" x-text="`Press 'Space' to flip, '← / →' to navigate`"></span>
                <button class="expand-btn" @click="closeFlashcardModal()">
                    <i class="ph ph-x"></i>
                </button>
            </div>
        </div>
        
        <div class="artifact-content" x-show="flashcards.length > 0">
            <div class="flashcard-viewer">
                <div class="flashcard-wrapper" @click="flipCard()">
                    <div class="flashcard" :class="{ 'flipped': isFlipped }">
                        <div class="flashcard-front">
                            <div class="card-content">
                                <p x-text="flashcards[currentFlashcard]?.front"></p>
                            </div>
                            <div class="flip-hint">See answer</div>
                        </div>
                        <div class="flashcard-back">
                            <div class="card-content">
                                <p x-text="flashcards[currentFlashcard]?.back"></p>
                            </div>
                            <div class="flip-hint">See question</div>
                        </div>
                    </div>
                </div>
                
                <div class="flashcard-navigation">
                    <button class="nav-btn" @click="prevCard()" :disabled="currentFlashcard === 0">
                        <i class="ph ph-arrow-left"></i>
                    </button>
                    <button class="nav-btn primary" @click="nextCard()" :disabled="currentFlashcard === flashcards.length - 1">
                        <i class="ph ph-arrow-right"></i>
                    </button>
                </div>
            </div>
        </div>
        
        <div class="artifact-content" x-show="!selectedChapter">
            <div class="artifact-empty-state">
                <div class="empty-icon">
                    <i class="ph ph-cards" style="font-size: 56px; color: #666;"></i>
                </div>
                <h3>No Chapter Selected</h3>
                <p>Please select a chapter first to view flashcards.</p>
            </div>
        </div>
        
        <div class="artifact-content" x-show="selectedChapter && flashcards.length === 0">
            <div class="artifact-empty-state">
                <div class="empty-icon">
                    <i class="ph ph-question" style="font-size: 56px; color: #666;"></i>
                </div>
                <h3>Flashcards Not Found</h3>
                <p>No flashcards available for this chapter yet. Please try another chapter.</p>
            </div>
        </div>
        
        <div class="flashcard-progress" x-show="flashcards.length > 0">
            <button class="progress-reset" @click="currentFlashcard = 0; isFlipped = false">
                <i class="ph ph-arrow-counter-clockwise"></i>
            </button>
            <div class="progress-bar-container">
                <div class="progress-bar-fill" :style="`width: ${((currentFlashcard + 1) / flashcards.length) * 100}%`"></div>
            </div>
            <span class="progress-counter" x-text="`${currentFlashcard + 1} / ${flashcards.length} cards`"></span>
        </div>
    </div>
</div>
        </div>
    </div>
</body>
</html>